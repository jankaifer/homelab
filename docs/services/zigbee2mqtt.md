# Zigbee2MQTT

Zigbee bridge service running in a Podman container with a USB coordinator.

## Status

**Enabled:** Yes

## Configuration

**Module:** `modules/services/zigbee2mqtt.nix`  
**Pattern:** `homelab.services.zigbee2mqtt.enable`

**Options:**

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `homelab.services.zigbee2mqtt.enable` | bool | false | Enable Zigbee2MQTT |
| `homelab.services.zigbee2mqtt.image` | string | `ghcr.io/koenkk/zigbee2mqtt:1.42.0` | Container image |
| `homelab.services.zigbee2mqtt.port` | int | 8080 | Frontend host port (proxied by Caddy) |
| `homelab.services.zigbee2mqtt.domain` | string | `zigbee.frame1.hobitin.eu` | UI domain |
| `homelab.services.zigbee2mqtt.dataDir` | path | `/var/lib/zigbee2mqtt` | Persistent data path |
| `homelab.services.zigbee2mqtt.serialPort` | string | `/dev/serial/by-id/usb-CHANGEME` | Zigbee coordinator path |
| `homelab.services.zigbee2mqtt.adapter` | enum | `ember` | Adapter type |
| `homelab.services.zigbee2mqtt.mqtt.*` | attrs | see module | MQTT TLS settings |

**Current configuration:**
```nix
homelab.services.zigbee2mqtt = {
  enable = true;
  serialPort = "/dev/serial/by-id/usb-CHANGEME";
  adapter = "ember";
  mqtt.passwordFile = config.age.secrets.mqtt-zigbee2mqtt-password.path;
};
```

## Runtime Model

- Managed by `virtualisation.oci-containers` (Podman backend)
- Config file generated by `zigbee2mqtt-config.service`
- Persistent state in `/var/lib/zigbee2mqtt`
- Coordinator passed through from host `/dev/serial/by-id/...`

## Access

| Environment | URL |
|-------------|-----|
| VM / Local | https://zigbee.frame1.hobitin.eu:8443 |
| Production | https://zigbee.frame1.hobitin.eu |

## MQTT Integration

Zigbee2MQTT is configured to connect with:
- `mqtts://mqtt.frame1.hobitin.eu:8883`
- User: `zigbee2mqtt`
- Password from agenix secret
- CA file: `/var/lib/acme/mqtt.frame1.hobitin.eu/fullchain.pem`

## Troubleshooting

Check generated config:
```bash
cat /var/lib/zigbee2mqtt/configuration.yaml
```

Check container service logs:
```bash
journalctl -u podman-zigbee2mqtt -n 200 --no-pager
```

Check coordinator path:
```bash
ls -l /dev/serial/by-id/
```

## Dependencies

- Mosquitto MQTT service
- Caddy reverse proxy
- Sonoff Zigbee USB coordinator

## Links

- [Zigbee2MQTT](https://www.zigbee2mqtt.io/)
- [Supported Adapters](https://www.zigbee2mqtt.io/guide/adapters/)
