# Homelab Project Plan

## Overview

NixOS-based homelab configuration with flakes. Optimized for AI-assisted development with a fast feedback loop via VM testing.

## Tech Stack

| Component | Choice | Rationale |
|-----------|--------|-----------|
| OS | NixOS with Flakes | Declarative, reproducible, rollback support |
| Secrets | agenix | Integrates well with NixOS, age encryption |
| Reverse Proxy | Caddy | Simple config, automatic HTTPS |
| Monitoring | Prometheus + Loki + Grafana | Industry standard, good NixOS support |
| Dashboard | Homepage | Simple, configurable service dashboard |

## Directory Structure

```
/
├── flake.nix                 # Main flake - defines inputs, outputs, machines
├── flake.lock
├── machines/
│   └── server/
│       ├── default.nix       # Machine config - imports needed modules
│       └── hardware.nix      # Hardware-specific (generated by nixos-generate-config)
├── modules/
│   └── services/             # One module per service, toggleable
│       ├── caddy.nix
│       ├── prometheus.nix
│       ├── loki.nix
│       ├── grafana.nix
│       └── homepage.nix
├── secrets/
│   ├── secrets.nix           # agenix secret declarations
│   └── *.age                  # Encrypted secret files
├── docs/
│   └── PROJECT_PLAN.md
└── CLAUDE.md
```

### Design Principles

1. **Machines import modules** - Each machine picks which services it runs
2. **Modules are self-contained** - Service module includes its NixOS config, not machine-specific details
3. **Secrets reference by path** - Modules expect secrets at known paths, agenix provides them

## AI Development Workflow

### Testing Changes (macOS with QEMU)

```bash
# Build a VM for the server config
nix build .#nixosConfigurations.server.config.system.build.vm

# Run the VM (QEMU)
./result/bin/run-server-vm
```

The VM boots with the full NixOS config. Claude can:
1. Make a config change
2. Build the VM
3. Boot and verify services work
4. Iterate

### Quick Validation (no VM)

```bash
# Just check it builds (fast, no runtime test)
nix build .#nixosConfigurations.server.config.system.build.toplevel --dry-run
```

## Initial Scope

### Phase 1: Foundation
- [ ] Basic flake.nix with NixOS configuration
- [ ] Server machine definition (placeholder hardware.nix for VM)
- [ ] Working `nix build` and VM boot

### Phase 2: Core Services
- [ ] Caddy module (reverse proxy)
- [ ] Homepage module (dashboard at root)

### Phase 3: Observability
- [ ] Prometheus module (metrics collection)
- [ ] Loki module (log aggregation)
- [ ] Grafana module (dashboards)
- [ ] Wire up: Caddy routes, service discovery

### Phase 4: Secrets
- [ ] agenix setup (keys, secret structure)
- [ ] Migrate any hardcoded secrets

## Module Pattern

Each service module follows this pattern:

```nix
# modules/services/example.nix
{ config, lib, pkgs, ... }:

let
  cfg = config.homelab.services.example;
in
{
  # Option to enable/disable this service
  options.homelab.services.example = {
    enable = lib.mkEnableOption "example service";

    port = lib.mkOption {
      type = lib.types.port;
      default = 8080;
      description = "Port for example service";
    };
  };

  # Actual configuration when enabled
  config = lib.mkIf cfg.enable {
    services.example = {
      enable = true;
      port = cfg.port;
    };
  };
}
```

Machine config then just enables what it needs:

```nix
# machines/server/default.nix
{
  homelab.services.example.enable = true;
  homelab.services.example.port = 9000;  # override default if needed
}
```

## VM Testing Notes

**On macOS:** NixOS VMs use QEMU. Ensure QEMU is installed:
```bash
# Via nix
nix-shell -p qemu

# Or via homebrew
brew install qemu
```

**VM Limitations:**
- No real hardware access (fine for service testing)
- Network is NAT'd - use port forwarding to access services
- Slower than native - use for verification, not development

**Port Forwarding Example:**
```bash
# Forward host 8080 to VM 80
QEMU_NET_OPTS="hostfwd=tcp::8080-:80" ./result/bin/run-server-vm
```

## Questions Resolved

| Question | Decision |
|----------|----------|
| Machine naming | Descriptive (`server`, `workstation`) |
| Workstation config | Skip for now, server only |
| Service complexity | Basic configs first, enhance later |
| Secrets | agenix structure ready, populate later |
| Testing approach | NixOS VM via QEMU on macOS |
