# Homelab Project Plan

## Overview

NixOS-based homelab configuration with flakes. Optimized for AI-assisted development with a fast feedback loop via VM testing.

## Tech Stack

| Component | Choice | Rationale |
|-----------|--------|-----------|
| OS | NixOS with Flakes | Declarative, reproducible, rollback support |
| Secrets | agenix | Integrates well with NixOS, age encryption |
| Reverse Proxy | Caddy | Simple config, automatic HTTPS |
| Monitoring | Prometheus + Loki + Grafana | Industry standard, good NixOS support |
| Dashboard | Homepage | Simple, configurable service dashboard |

## Directory Structure

```
/
├── flake.nix                 # Main flake - defines inputs, outputs, machines
├── flake.lock
├── machines/
│   └── server/
│       ├── default.nix       # Machine config - imports needed modules
│       └── hardware.nix      # Hardware-specific (generated by nixos-generate-config)
├── modules/
│   └── services/             # One module per service, toggleable
│       ├── caddy.nix
│       ├── homepage.nix
│       ├── prometheus.nix    # TODO
│       ├── loki.nix          # TODO
│       └── grafana.nix       # TODO
├── secrets/
│   ├── secrets.nix           # agenix secret declarations
│   └── *.age                  # Encrypted secret files
├── docs/
│   └── PROJECT_PLAN.md
└── CLAUDE.md
```

### Design Principles

1. **Machines import modules** - Each machine picks which services it runs
2. **Modules are self-contained** - Service module includes its NixOS config, not machine-specific details
3. **Secrets reference by path** - Modules expect secrets at known paths, agenix provides them

## Machine Configurations

| Name | System | Purpose |
|------|--------|---------|
| `server` | x86_64-linux | Production server deployment |
| `server-vm` | aarch64-linux | Local VM testing on Apple Silicon |

## AI Development Workflow

### Quick Validation (no builder needed)

```bash
# Check config evaluates correctly - fast syntax/type checking
nix eval .#nixosConfigurations.server-vm.config.system.build.toplevel --apply 'x: x.drvPath'
```

### Full VM Testing (requires linux-builder)

```bash
# Terminal 1: Start linux-builder (keep running)
nix run nixpkgs#darwin.linux-builder

# Terminal 2: Build and run VM
nix build .#nixosConfigurations.server-vm.config.system.build.vm
QEMU_NET_OPTS="hostfwd=tcp::3000-:3000,hostfwd=tcp::2222-:22" ./result/bin/run-server-vm
```

The VM boots with the full NixOS config. Access:
- Homepage dashboard: http://localhost:3000
- SSH: `ssh -p 2222 admin@localhost` (password: `nixos`)

## Initial Scope

### Phase 1: Foundation ✓
- [x] Basic flake.nix with NixOS configuration
- [x] Server machine definition
- [x] VM configuration for Apple Silicon testing
- [ ] Working VM build (linux-builder setup in progress)

### Phase 2: Core Services (in progress)
- [x] Homepage module (dashboard)
- [ ] Caddy module (reverse proxy) - defined but not enabled

### Phase 3: Observability
- [ ] Prometheus module (metrics collection)
- [ ] Loki module (log aggregation)
- [ ] Grafana module (dashboards)
- [ ] Wire up: Caddy routes, service discovery

### Phase 4: Secrets
- [x] agenix structure ready
- [ ] Add SSH keys for secret encryption
- [ ] Migrate any hardcoded secrets

## Module Pattern

Each service module follows this pattern:

```nix
# modules/services/example.nix
{ config, lib, pkgs, ... }:

let
  cfg = config.homelab.services.example;
in
{
  # Option to enable/disable this service
  options.homelab.services.example = {
    enable = lib.mkEnableOption "example service";

    port = lib.mkOption {
      type = lib.types.port;
      default = 8080;
      description = "Port for example service";
    };
  };

  # Actual configuration when enabled
  config = lib.mkIf cfg.enable {
    services.example = {
      enable = true;
      port = cfg.port;
    };
  };
}
```

Machine config then just enables what it needs:

```nix
# machines/server/default.nix
{
  homelab.services.example.enable = true;
  homelab.services.example.port = 9000;  # override default if needed
}
```

## macOS Linux Builder Setup

Building NixOS on macOS requires a Linux builder. The nixpkgs `darwin.linux-builder` provides a free QEMU-based solution.

### One-time setup

```bash
# 1. Start the linux-builder (will prompt for sudo to install SSH keys)
nix run nixpkgs#darwin.linux-builder

# 2. In another terminal, add builder to nix config
sudo tee -a /etc/nix/nix.custom.conf << 'EOF'
builders = ssh-ng://linux-builder aarch64-linux /etc/nix/builder_ed25519 4 - - - c3NoLWVkMjU1MTkgQUFBQUMzTnphQzFsWkRJMU5URTVBQUFBSU9BMWZHWVRYZ1B0SG9OMkVVSTlVTjAyRUhIVU5Fd2oyWXV3aG5NOUVVTmkgcm9vdEBuaXhvcwo=
builders-use-substitutes = true
EOF

# 3. Restart nix daemon
sudo launchctl kickstart -k system/systems.determinate.nix-daemon
```

### Each development session

Keep the linux-builder running in a terminal while building:

```bash
nix run nixpkgs#darwin.linux-builder
```

## Questions Resolved

| Question | Decision |
|----------|----------|
| Machine naming | Descriptive (`server`, `workstation`) |
| Workstation config | Skip for now, server only |
| Service complexity | Basic configs first, enhance later |
| Secrets | agenix structure ready, populate later |
| Testing approach | NixOS VM via nixpkgs linux-builder on macOS |
| VM architecture | aarch64-linux for Apple Silicon native speed |
